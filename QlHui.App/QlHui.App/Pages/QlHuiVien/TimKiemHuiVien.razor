@page "/TimKiemHuiVien"
@using QlHui.App.Data.Services
@inherits NotificationBase;
@inject DialogService dialogService;
@inject NavigationManager navManager;

@inject IQlHuiVienService service;

<RadzenText TextStyle="TextStyle.Subtitle1" TagName="TagName.H6" class="rz-p-2 rz-color-primary" Style="font-weight:bold;">Điều kiện tìm kiếm</RadzenText>
<RadzenCard>
    <RadzenRow class="rz-p-2">
        <RadzenColumn Size="4" >
            <RadzenStack Orientation="Orientation.Horizontal">
                <RadzenText>Mã hụi viên</RadzenText>
                <RadzenTextBox @bind-Value=@searchCriteria.MaHuiVien />
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn Size="4">
            <RadzenStack Orientation="Orientation.Horizontal">
                <RadzenText>Tên hụi viên</RadzenText>
                <RadzenTextBox @bind-Value=@searchCriteria.TenHuiVien  />
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn Size="2">
            <RadzenStack Orientation="Orientation.Horizontal">
                <RadzenCheckBox @bind-Value=@searchCriteria.CanThuTien Name="cbCanThu" TValue="bool" />
                <RadzenLabel Text="Cần thu tiền" Component="cbCanThu" />
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn Size="2">
            <RadzenStack Orientation="Orientation.Horizontal">
                <RadzenCheckBox @bind-Value=@searchCriteria.CanTraTien Name="cbCanTra" TValue="bool" />
                <RadzenLabel Text="Cần trả tiền" Component="cbCanThu" />
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-p-2">
        <RadzenButton Text="Tìm kiếm" ButtonStyle="ButtonStyle.Info" Icon="search" Click=@OnClickSearchData  />
    </RadzenStack>
</RadzenCard>
<RadzenText TextStyle="TextStyle.Subtitle1" TagName="TagName.H6" class="rz-p-2 rz-color-primary" Style="font-weight:bold;">Danh sách kết quả</RadzenText>
<RadzenDataGrid TItem="HuiVienKetQuaTimKiemDto" Data=@listSearchData AllowSorting="true" IsLoading=@isSearchLoadingShow Density="Density.Default">
    <EmptyTemplate>
        <p style="color: lightgrey; font-size: 18px; text-align: center; margin: 2rem;">@Const.EmptyTable</p>
    </EmptyTemplate>
    <Columns>
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="Index" Title="#" Width="10%" TextAlign="TextAlign.Center">

            <Template>
                @(listSearchData.IndexOf(context) + 1)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="Id" Title="Thao tác" TextAlign="TextAlign.Center" Width="10%">
            <Template Context="data">
                <RadzenButton ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" 
                              Visible="@(data.TrangThai != null &&  data.TrangThai != (int)TrangThaiDongHui.DA_THU)"
                              Icon="visibility" title="Xem chi tiết" Click="@(args=>RedirectToDetailPage(data.HuiVienId))" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="MaHuiVien" Title="Mã hụi viên" Width="20%" />
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="TenHuiVien" Title="Tên hụi viên" Width="20%" />
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="TrangThai" Title="Trạng thái" TextAlign="TextAlign.Center" Width="10%">
            <Template Context="data">
                <RadzenLabel Visible=@(data.TrangThai==(int)TrangThaiDongHui.CHUA_THU) class="rz-color-danger">Chưa thu</RadzenLabel>
                <RadzenLabel Visible=@(data.TrangThai==(int)TrangThaiDongHui.DA_THU) class="rz-color-success">Đã thu</RadzenLabel>
                <RadzenLabel Visible=@(data.TrangThai==(int)TrangThaiDongHui.CHUA_TRA) class="rz-color-warning">Chưa trả</RadzenLabel>
                <RadzenLabel Visible=@(data.TrangThai==(int)TrangThaiDongHui.DA_TRA) class="rz-color-success">Đã trả</RadzenLabel>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="TongPhaiThu" Title="Tổng phải thu" TextAlign="TextAlign.Right" Width="20%">
            <Template Context="data">
                <span>@(data.TongPhaiThu.GetMoneyFormat())</span>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="HuiVienKetQuaTimKiemDto" Property="TongPhaiTra" Title="Tổng phải trả" TextAlign="TextAlign.Right" Width="20%">
            <Template Context="data">
                <span>@(data.TongPhaiTra.GetMoneyFormat())</span>
            </Template>
        </RadzenDataGridColumn>


    </Columns>
</RadzenDataGrid>
<RadzenPager ShowPagingSummary="true" PagingSummaryFormat="@pagingSummaryFormat" HorizontalAlign="HorizontalAlign.Center"
             Count="totalItems" PageSize="@panigation.Take" PageNumbersCount="@(totalItems/panigation.Take)" PageChanged="@PageChanged" />
@code {
    HuiVienTieuChiTimKiemDto searchCriteria = new();
    IList<HuiVienKetQuaTimKiemDto> listSearchData = new List<HuiVienKetQuaTimKiemDto>();
    PanigationDto panigation = new PanigationDto();
    bool isSearchLoadingShow = false;
    int totalItems = 0;
    string pagingSummaryFormat = Const.SummaryTable;
    protected override void OnInitialized()
    {
        //dialogService.OnOpen += OpenCreateNewDialog;
        //dialogService.OnClose += CloseCreateNewDialog;
        OnClickSearchData();
    }

    void OnClickSearchData()
    {
        try
        {
            isSearchLoadingShow = true;
            var getData = service.TimKiemHuiVien(searchCriteria, panigation);
            if (getData != null && getData.Data != null && getData.Data.Count>0)
            {
                totalItems = getData.TotalItem;
                listSearchData = getData.Data;
            }
            else
            {
                listSearchData = new List<HuiVienKetQuaTimKiemDto>();
            }
        }
        catch (Exception ex)
        {
            ShowErrorNotification(ex.GetError());
        }
        isSearchLoadingShow = false;
    }
    void PageChanged(PagerEventArgs args)
    {
        panigation.Skip = args.Skip;
        panigation.Take = args.Top;
        OnClickSearchData();
    }
    void RedirectToDetailPage(int id)
    {
        navManager.NavigateTo($"/ChiTietTheoHuiVien/{id}");
    }
}
